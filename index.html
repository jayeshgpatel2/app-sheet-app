<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>InArt Stock Dashboard (Advanced)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        /* Custom styles for responsiveness and clean look */
        .stock-badge {
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.7rem;
            display: inline-block;
            white-space: nowrap;
        }
        .stock-ok { background: #dcfce7; color: #15803d; }
        .stock-low { background: #fef3c7; color: #b45309; } /* Warning yellow */
        .stock-zero { background: #fee2e2; color: #b91c1c; } /* Danger red */

        /* Ensures the table header stays visible on scroll (desktop view) */
        @media (min-width: 768px) {
            .sticky-header th {
                position: sticky;
                top: 0;
                z-index: 10;
            }
        }
        
        /* Utility for image placeholders */
        .no-img {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #9ca3af;
        }
    </style>
</head>
<body class="min-h-screen">
<header class="bg-gray-900 text-white p-4 flex items-center justify-between shadow-lg flex-wrap gap-2">
    <h1 class="text-xl font-bold">InArt Inventory Dashboard</h1>
    <span class="bg-green-500 text-xs font-semibold px-3 py-1 rounded-full shadow">Live Data</span>
</header>

<main class="p-4 md:p-6 max-w-7xl mx-auto">
    <!-- Summary Cards -->
    <section class="summary grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl p-4 shadow-md transition duration-300 hover:shadow-lg">
            <div class="text-xs font-semibold uppercase text-gray-500 mb-1">Total SKUs</div>
            <div class="text-2xl font-bold text-gray-900" id="statTotalSkus">‚Äì</div>
            <div class="text-xs text-gray-400 mt-1" id="statTotalCategories">‚Äì</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-md transition duration-300 hover:shadow-lg">
            <div class="text-xs font-semibold uppercase text-gray-500 mb-1">Units in Stock</div>
            <div class="text-2xl font-bold text-green-600" id="statUnitsStock">‚Äì</div>
            <div class="text-xs text-gray-400 mt-1" id="statLowStock">‚Äì</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-md transition duration-300 hover:shadow-lg col-span-2 md:col-span-1">
            <div class="text-xs font-semibold uppercase text-gray-500 mb-1">Best Seller (Qty)</div>
            <div class="text-xl font-bold text-gray-800 truncate" id="statBestSeller">‚Äì</div>
            <div class="text-xs text-gray-400 mt-1" id="statBestSellerQty">‚Äì</div>
        </div>
    </section>

    <!-- Filters and Controls -->
    <section class="controls grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
        <input type="text" id="searchInput" placeholder="Search by name, code, ASIN, SKU‚Ä¶" 
               class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm"/>
        
        <select id="categoryFilter" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
            <option value="">All categories</option>
        </select>
        <select id="vendorFilter" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
            <option value="">All vendors</option>
        </select>
        <select id="sortMode" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
            <option value="name">Sort: Product name (A-Z)</option>
            <option value="stockDesc">Sort: Stock high ‚Üí low</option>
            <option value="stockAsc">Sort: Stock low ‚Üí high</option>
            <option value="salesDesc">Sort: Best sellers (Qty)</option>
        </select>
    </section>

    <!-- View Pills -->
    <section class="flex flex-wrap gap-2 mb-6">
        <button class="pill active px-4 py-1.5 text-sm rounded-full border transition duration-150" data-view="all">All products</button>
        <button class="pill px-4 py-1.5 text-sm rounded-full border transition duration-150" data-view="low">Low stock</button>
        <button class="pill px-4 py-1.5 text-sm rounded-full border transition duration-150" data-view="zero">Out of stock</button>
        <button class="pill px-4 py-1.5 text-sm rounded-full border transition duration-150" data-view="best">Best sellers</button>
    </section>

    <!-- Mobile Card List View (Default) -->
    <section id="cardListView" class="block md:hidden space-y-3">
        <!-- Cards will be injected here -->
        <div class="text-center p-4 text-gray-500">Loading data...</div>
    </section>


    <!-- Desktop Table View (Hidden on mobile) -->
    <section class="hidden md:block overflow-x-auto bg-white rounded-xl shadow-lg">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-800 text-white sticky-header">
                <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider w-16">Image</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Product</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Barcode</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Category / Vendor</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">ASIN / SKU</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Cost</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Stock</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Purchases</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Sales</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                <!-- Rows will be injected here -->
            </tbody>
        </table>
    </section>
</main>

<script>
    // === CONFIG: your CSV endpoints ===
    const PRODUCT_CSV =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vTigsGhlpnrwXI_q8RklVhfc7cD8dezLyLS9fXHN842Tk6dM430UVo5UTMjFKV08P3f0pKNtsadi-t3/pub?gid=2104089495&single=true&output=csv";
    const SALES_CSV =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vTigsGhlpnrwXI_q8RklVhfc7cD8dezLyLS9fXHN842Tk6dM430UVo5UTMjFKV08P3f0pKNtsadi-t3/pub?gid=438476529&single=true&output=csv";
    const PURCHASES_CSV =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vTigsGhlpnrwXI_q8RklVhfc7cD8dezLyLS9fXHN842Tk6dM430UVo5UTMjFKV08P3f0pKNtsadi-t3/pub?gid=1808784762&single=true&output=csv";

    // Simple CSV parser
    function parseCSV(text) {
        const lines = text.trim().split(/\r?\n/);
        return lines.map(line => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"' && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(s => s.trim()); // Trim cells after parsing
        });
    }

    async function fetchCSV(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Failed to fetch " + url);
        const txt = await res.text();
        return parseCSV(txt);
    }

    function indexHeaders(row) {
        const map = {};
        row.forEach((h, idx) => {
            map[h] = idx;
        });
        return map;
    }

    const state = {
        productsByBarcode: {},
        productsList: [],
        viewMode: "all"
    };

    async function loadData() {
        try {
            const [prodRows, salesRows, purchaseRows] = await Promise.all([
                fetchCSV(PRODUCT_CSV),
                fetchCSV(SALES_CSV),
                fetchCSV(PURCHASES_CSV)
            ]);

            const prodHeader = indexHeaders(prodRows[0]);
            const salesHeader = indexHeaders(salesRows[0] || []);
            const purchHeader = indexHeaders(purchaseRows[0] || []);

            // Clear existing data
            state.productsByBarcode = {};
            state.productsList = [];

            // Build products
            for (let i = 1; i < prodRows.length; i++) {
                const r = prodRows[i];
                if (!r.length || r.every(cell => !cell)) continue;
                
                const barcode = r[prodHeader["Product Barcode"]] || "";
                if (!barcode) continue;
                
                const imageUrl = r[prodHeader["Image_URL"]]
                              || r[prodHeader["Image"]]
                              || r[prodHeader["AMAZON IMAGE"]]
                              || "";
                
                const p = {
                    barcode,
                    name: r[prodHeader["Product"]] || "",
                    category: r[prodHeader["Category"]] || "",
                    image: imageUrl,
                    initialStock: Number(r[prodHeader["Initial Stock"]] || 0),
                    restockLevel: Number(r[prodHeader["Restock Level"]] || 0),
                    cost: r[prodHeader["Cost"]] || "",
                    vendor: r[prodHeader["Vendor"]] || "",
                    asin: r[prodHeader["AMAZON ASIN INART"]] || "",
                    sku: r[prodHeader["AMAZON SKU INART"]] || "",
                    purchases: 0,
                    sales: 0,
                    currentStock: 0
                };
                state.productsByBarcode[barcode] = p;
            }

            // Aggregate sales
            if (salesRows.length > 1) {
                const idxBarcode = salesHeader["Product Barcode"];
                const idxQty = salesHeader["Quantity"];
                for (let i = 1; i < salesRows.length; i++) {
                    const r = salesRows[i];
                    if (!r.length || r.every(cell => !cell)) continue;
                    const bc = r[idxBarcode] || "";
                    const qty = Number(r[idxQty] || 0);
                    if (state.productsByBarcode[bc]) {
                        state.productsByBarcode[bc].sales += qty;
                    }
                }
            }

            // Aggregate purchases
            if (purchaseRows.length > 1) {
                const idxBarcode = purchHeader["Product Barcode"];
                const idxQty = purchHeader["Quantity"];
                for (let i = 1; i < purchaseRows.length; i++) {
                    const r = purchaseRows[i];
                    if (!r.length || r.every(cell => !cell)) continue;
                    const bc = r[idxBarcode] || "";
                    const qty = Number(r[idxQty] || 0);
                    if (state.productsByBarcode[bc]) {
                        state.productsByBarcode[bc].purchases += qty;
                    }
                }
            }

            // Compute current stock
            state.productsList = Object.values(state.productsByBarcode);
            state.productsList.forEach(p => {
                p.currentStock = p.initialStock + p.purchases - p.sales;
            });

            populateFilters();
            updateSummary();
            renderTables();
            
        } catch (err) {
            console.error("Load error:", err);
            // Replace alert with a temporary message box if possible, but for simplicity here, we stick to console/basic text.
            document.getElementById("tableBody").innerHTML = '<tr><td colspan="9" class="text-center p-4 text-red-500">Error loading data. Check console for details.</td></tr>';
            document.getElementById("cardListView").innerHTML = '<div class="text-center p-4 text-red-500">Error loading data. Check console for details.</div>';
        }
    }

    function populateFilters() {
        const categorySet = new Set();
        const vendorSet = new Set();
        state.productsList.forEach(p => {
            if (p.category) categorySet.add(p.category);
            if (p.vendor) vendorSet.add(p.vendor);
        });
        
        const categoryFilter = document.getElementById("categoryFilter");
        const vendorFilter = document.getElementById("vendorFilter");

        categoryFilter.innerHTML = '<option value="">All categories</option>';
        vendorFilter.innerHTML = '<option value="">All vendors</option>';

        [...categorySet].sort().forEach(cat => {
            const opt = document.createElement("option");
            opt.value = cat;
            opt.textContent = cat;
            categoryFilter.appendChild(opt);
        });
        
        [...vendorSet].sort().forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            vendorFilter.appendChild(opt);
        });
    }

    function updateSummary() {
        const totalSkus = state.productsList.length;
        const categories = new Set(state.productsList.map(p => p.category).filter(Boolean));
        const totalUnits = state.productsList.reduce((sum, p) => sum + (p.currentStock || 0), 0);
        const lowStockCount = state.productsList.filter(p => 
            p.currentStock > 0 && p.currentStock <= p.restockLevel
        ).length;
        const best = state.productsList.slice().sort((a, b) => (b.sales || 0) - (a.sales || 0))[0];

        document.getElementById("statTotalSkus").textContent = totalSkus;
        document.getElementById("statTotalCategories").textContent =
            categories.size + " unique categories";

        document.getElementById("statUnitsStock").textContent = totalUnits.toLocaleString();
        document.getElementById("statLowStock").textContent =
            lowStockCount + " low/below restock";

        if (best && best.sales > 0) {
            const name = best.name || best.barcode;
            document.getElementById("statBestSeller").textContent = name;
            document.getElementById("statBestSellerQty").textContent =
                best.sales.toLocaleString() + " units sold";
        } else {
            document.getElementById("statBestSeller").textContent = "N/A";
            document.getElementById("statBestSellerQty").textContent = "No sales yet";
        }
    }

    function getFilteredProducts() {
        const search = document.getElementById("searchInput").value.trim().toLowerCase();
        const category = document.getElementById("categoryFilter").value;
        const vendor = document.getElementById("vendorFilter").value;
        const sortMode = document.getElementById("sortMode").value;

        let list = state.productsList.slice();

        // View Mode Filter
        if (state.viewMode === "low") {
            list = list.filter(p => p.currentStock <= p.restockLevel && p.currentStock > 0);
        } else if (state.viewMode === "zero") {
            list = list.filter(p => p.currentStock <= 0);
        } else if (state.viewMode === "best") {
            list = list.filter(p => p.sales > 0);
        }

        // Dropdown Filters
        if (category) {
            list = list.filter(p => p.category === category);
        }
        if (vendor) {
            list = list.filter(p => p.vendor === vendor);
        }
        
        // Search Filter
        if (search) {
            list = list.filter(p => {
                const s = [
                    p.name,
                    p.barcode,
                    p.category,
                    p.vendor,
                    p.asin,
                    p.sku
                ].join(" ").toLowerCase();
                return s.includes(search);
            });
        }

        // Sorting
        if (sortMode === "name") {
            list.sort((a, b) => (a.name || a.barcode).localeCompare(b.name || b.barcode));
        } else if (sortMode === "stockDesc") {
            list.sort((a, b) => (b.currentStock || 0) - (a.currentStock || 0));
        } else if (sortMode === "stockAsc") {
            list.sort((a, b) => (a.currentStock || 0) - (b.currentStock || 0));
        } else if (sortMode === "salesDesc") {
            list.sort((a, b) => (b.sales || 0) - (a.sales || 0));
        }

        return list;
    }

    function getStockStatus(p) {
        let cls = "stock-ok";
        let label = "OK";
        if (p.currentStock <= 0) {
            cls = "stock-zero";
            label = "OUT";
        } else if (p.currentStock <= p.restockLevel) {
            cls = "stock-low";
            label = "LOW";
        }
        return { cls, label };
    }

    function createCardHtml(p) {
        const { cls, label } = getStockStatus(p);

        const imageHtml = p.image && p.image.startsWith("http")
            ? `<img src="${p.image}" alt="${p.name || p.barcode}" 
                    class="w-16 h-16 rounded-lg object-cover border border-gray-200 bg-gray-50"
                    onerror="this.onerror=null; this.src='https://placehold.co/64x64/f3f4f6/9ca3af?text=N/A'" />`
            : `<div class="no-img w-16 h-16 text-3xl">üñºÔ∏è</div>`;

        return `
            <div class="bg-white rounded-xl shadow-md p-3 flex gap-3 items-center transition duration-150 hover:shadow-lg">
                <div class="flex-shrink-0">${imageHtml}</div>
                <div class="flex-grow min-w-0">
                    <div class="flex items-center justify-between mb-1">
                        <div class="font-semibold truncate text-gray-800">${p.name || "Unnamed Product"}</div>
                        <span class="text-xs font-bold text-gray-600 ${cls} px-2 py-0.5 rounded">${p.currentStock}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-x-2 text-xs text-gray-500 mt-1">
                        <!-- Category / Vendor (PRIORITIZED FIELD 1/2) -->
                        <div class="truncate">
                            <span class="font-medium text-gray-700">Category:</span> ${p.category || '‚Äì'}
                        </div>
                        <div class="truncate text-right">
                             <span class="font-medium text-gray-700">Vendor:</span> ${p.vendor || '‚Äì'}
                        </div>
                        <!-- ASIN / SKU (PRIORITIZED FIELD 3/4) -->
                        <div class="truncate">
                            <span class="font-medium text-gray-700">ASIN:</span> ${p.asin || '‚Äì'}
                        </div>
                        <div class="truncate text-right">
                            <span class="font-medium text-gray-700">SKU:</span> ${p.sku || '‚Äì'}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderTables() {
        const list = getFilteredProducts();
        const tbody = document.getElementById("tableBody");
        const cardView = document.getElementById("cardListView");
        
        tbody.innerHTML = "";
        cardView.innerHTML = "";

        if (list.length === 0) {
            const noDataHtml = '<td colspan="9" class="text-center p-4 text-gray-500">No products match your filters.</td>';
            tbody.innerHTML = `<tr>${noDataHtml}</tr>`;
            cardView.innerHTML = '<div class="text-center p-4 text-gray-500">No products match your filters.</div>';
            return;
        }

        // 1. Render Table Rows (Desktop)
        list.forEach(p => {
            const { cls } = getStockStatus(p);
            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50 transition duration-100";
            
            // Image Cell (PRIORITIZED FIELD 1)
            const imageHtml = p.image && p.image.startsWith("http")
                ? `<img src="${p.image}" alt="${p.name || p.barcode}" 
                       class="w-12 h-12 rounded-lg object-cover border border-gray-200 bg-gray-50"
                       onerror="this.onerror=null; this.src='https://placehold.co/48x48/f3f4f6/9ca3af?text=N/A'" />`
                : `<div class="no-img w-12 h-12 text-2xl">üñºÔ∏è</div>`;

            tr.innerHTML = `
                <td class="px-3 py-2 whitespace-nowrap">${imageHtml}</td>
                <td class="px-3 py-2">
                    <div class="font-medium text-gray-900">${p.name || "‚Äì"}</div>
                    <div class="text-gray-500 text-xs">${p.barcode}</div>
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-gray-600">${p.barcode}</td>
                <td class="px-3 py-2 whitespace-nowrap">
                    <div class="font-medium text-gray-700">${p.category || '‚Äì'}</div>
                    <div class="text-gray-500 text-xs">Vendor: ${p.vendor || '‚Äì'}</div>
                </td>
                <td class="px-3 py-2 whitespace-nowrap">
                    <div class="font-medium text-gray-700">${p.asin || '‚Äì'}</div>
                    <div class="text-gray-500 text-xs">${p.sku || '‚Äì'}</div>
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-gray-600">${p.cost || '‚Äì'}</td>
                <td class="px-3 py-2 whitespace-nowrap">
                    <span class="stock-badge ${cls}">${p.currentStock}</span>
                    ${p.restockLevel ? `<div class="text-gray-500 text-xs">Restock: ${p.restockLevel}</div>` : ''}
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-gray-600">${p.purchases || 0}</td>
                <td class="px-3 py-2 whitespace-nowrap text-gray-600">${p.sales || 0}</td>
            `;
            tbody.appendChild(tr);
        });

        // 2. Render Card List (Mobile)
        const cardHtml = list.map(p => createCardHtml(p)).join('');
        cardView.innerHTML = cardHtml;
    }

    // Event wiring
    document.addEventListener("DOMContentLoaded", () => {
        // Initial load
        loadData();

        // Attach event listeners to all filter/sort controls to trigger a re-render
        const controls = [
            document.getElementById("searchInput"),
            document.getElementById("categoryFilter"),
            document.getElementById("vendorFilter"),
            document.getElementById("sortMode")
        ];
        
        controls.forEach(control => {
            control.addEventListener(control.tagName === 'INPUT' ? "input" : "change", renderTables);
        });

        // Pill group for view mode
        document.querySelectorAll(".pill").forEach(btn => {
            btn.classList.add("bg-white", "text-gray-700", "border-gray-300", "shadow-sm");
            btn.addEventListener("click", () => {
                document.querySelectorAll(".pill").forEach(b => {
                    b.classList.remove("active", "bg-gray-800", "text-white", "border-gray-800");
                    b.classList.add("bg-white", "text-gray-700", "border-gray-300");
                });
                btn.classList.add("active", "bg-gray-800", "text-white", "border-gray-800");
                btn.classList.remove("bg-white", "text-gray-700", "border-gray-300");
                state.viewMode = btn.dataset.view;
                renderTables();
            });
        });

        // Initialize the 'All products' pill style
        document.querySelector('.pill.active').classList.add("bg-gray-800", "text-white", "border-gray-800");
        document.querySelector('.pill.active').classList.remove("bg-white", "text-gray-700", "border-gray-300");

    });
</script>
</body>
</html>
